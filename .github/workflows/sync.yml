name: Sync Upstream

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync_and_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for upstream changes
        id: check
        env:
          UPSTREAM_URL: https://github.com/PlayPro/CoreProtect.git
          UPSTREAM_BRANCH: master
          TARGET_BRANCH: main 
        run: |
          git remote add upstream $UPSTREAM_URL
          git fetch upstream $UPSTREAM_BRANCH

          CHANGED_FILES=$(git diff --name-only HEAD upstream/$UPSTREAM_BRANCH)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes found."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found changed files:"
          echo "$CHANGED_FILES"

          IMPORTANT_CHANGES=$(echo "$CHANGED_FILES" | grep -v -E '^README\.md$|^\.github/workflows/')

          if [ -z "$IMPORTANT_CHANGES" ]; then
            echo "Skipping: Only ignored files (README or workflows) were changed."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Valid changes detected. Proceeding to PR."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_URL: https://github.com/PlayPro/CoreProtect.git
          UPSTREAM_BRANCH: master
        run: |
          SYNC_BRANCH="upstream-sync-$(date +%s)"
          
          git checkout -b $SYNC_BRANCH upstream/$UPSTREAM_BRANCH
          
          git push origin $SYNC_BRANCH

          gh pr create \
            --title "chore: Sync with Upstream" \
            --body "This PR syncs the latest changes from upstream, excluding ignored files." \
            --base main \
            --head $SYNC_BRANCH
